<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocularis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Schibsted+Grotesk:ital,wght@0,400..900;1,400..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>

<body>
    <div class="container">
        <div class="left-sidebar-container">
            <div class="left-sidebar">
                <div class="namelogo">
                    <img src="..\static\Logo.png" class="logo">
                    <div class="name">Ocularis</div>
                </div>
                <ul class="sidebar-menu">
                    <li><a>
                            <div class="icon-text-wrapper current">
                                <span class="material-symbols-outlined sidebar-symbol">newspaper</span>
                                <div>Feed</div>
                            </div>
                        </a></li>
                    <li><a href="{{ url_for('recommendations') }}">
                            <div class="icon-text-wrapper">
                                <span class="material-symbols-outlined sidebar-symbol">group</span>
                                <div>Match</div>
                            </div>
                        </a></li>
                    <li><a href="{{ url_for('profile', user_id=current_user.id) }}">
                            <div class="icon-text-wrapper">
                                <span class="material-symbols-outlined sidebar-symbol">person</span>
                                <div>Profile</div>
                            </div>
                        </a></li>
                    <li><a href="{{ url_for('logout') }}">
                            <div class="icon-text-wrapper">
                                <span class="material-symbols-outlined sidebar-symbol">logout</span>
                                <div>Logout</div>
                            </div>
                        </a></li>
                </ul>
            </div>
        </div>
        <div class="header">
            <form class="search-wrapper hide-mobile" action="{{ url_for('search.search_results') }}" method="GET">
                <input class="search" type="text" name="query" placeholder="Search" required>
                <button class="search-button" type="submit"><span
                        class="material-symbols-outlined search-symbol">search</span></button>
            </form>
            <div class="hide-pfp">
                <button class="notifs-button"><span
                        class="material-symbols-outlined notifs-symbol">notifications</span></button>
                <div class="pfp-frame-wrapper">
                    <div><img src="..\static\pfp.jpg" class="pfp right" id="pfp3"></div>
                    <div class="frame3" id="frame3">
                        <div class="frame-username">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                        <div class="line"></div>
                        <div class="saved">Saved</div>
                        <div class="settings">Settings</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mobile-only">
            <img src="..\static\Logo.png" class="logo">
            <div class="button-pfp-wrapper">
                <button class="search-button"><span
                        class="material-symbols-outlined search-symbol">search</span></button>
                <button class="notifs-button"><span
                        class="material-symbols-outlined notifs-symbol">notifications</span></button>
                <div class="pfp-frame-wrapper">
                    <div><img src="..\static\pfp.jpg" class="pfp right" id="pfp4"></div>
                    <div class="frame4" id="frame4">
                        <div class="frame-username">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                        <div class="line"></div>
                        <div class="saved">Saved</div>
                        <div class="settings">Settings</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="feed">
            <div class="post">
                <div class="post-title">Post</div>
                <div class="tagline-wrapper">
                    <div class="tagline-wrapper-2">
                        <img src="..\static\pfp.jpg" class="pfp">
                        <input class="post-tagline" type="text" placeholder="Do you mind sharing your work?">
                    </div>
                    <button class="image-button" id="openOverlay"><span
                            class="material-symbols-outlined image">image</span></button>
                </div>
            </div>
            <div class="overlay" id="overlay"> <!--stay on current view during overlay??-->
                <div class="overlay-content">
                    <button class="close-icon"><span class="material-symbols-outlined overlay-close-symbol"
                            id="closeOverlay">close</span></button>
                    <div class="overlay-title">Post</div>
                    <div class="scrollable-div no-scroll" id="scrollableDiv">
                        <div class="profile-post">
                            <img src="..\static\pfp.jpg" class="pfp">
                            <div class="profile-name-date">
                                <div class="username">Lorem ipsum dolor</div>
                                <div class="date">Jan 1</div>
                            </div>
                        </div>
                        <form action="{{ url_for('feed') }}" method="POST" enctype="multipart/form-data">
                            <input class="overlay-tagline" type="text" id="caption" name="caption"
                                placeholder="Do you mind sharing your work?">
                            <div class="upload">
                                <span class="material-symbols-outlined overlay-upload-symbol">upload</span>
                                <div class="drop">Drop your images here or browse</div>
                                <div class="supports">Supports PNG, JPG, JPEG, and GIF</div>
                                <button class="browse-file" type="button"
                                    onclick="document.getElementById('image').click();">
                                    Browse File
                                </button>
                                <input type="file" id="image" name="image" accept="image/*" style="display: none;"
                                    required>
                            </div>
                            <div class="image-button-wrapper" id="imageWrapper" style="display: none;">
                                <div class="image-container-overlay"><img class="image-post" id="uploadedImagePreview">
                                </div>
                                <button class="circled-icon-1-overlay-version"><span
                                        class="material-symbols-outlined close-symbol-overlay-version">close</span></button>
                            </div>
                    </div>
                    <input type="submit" value="Post" class="post-button">
                    </form>
                </div>
            </div>
            <!--bakit naka-center ung post 1 kapag un lang ung content-->
            <!--fix class names-->
            {% for image in images %}
            <div class="post1">
                <div class="profile-more-wrapper">
                    <div class="profile-post">
                        <img src="..\static\pfp.jpg" class="pfp">
                        <div class="profile-name-date">
                            <div class="username"><a href="{{ url_for('profile', user_id=image[4]) }}">{{ image[5] }} {{
                                    image[6] }}</a></div>
                            <div class="date">Jan 1</div>
                        </div>
                    </div>
                    <div class="more-frame-wrapper">
                        <span class="material-symbols-outlined more-symbol"
                            id="moreBtn-{{ loop.index }}">more_horiz</span>
                        <div class="frame1" id="frame1-{{ loop.index }}">
                            <div class="save">Save</div>
                            <div class="hide">Hide</div>
                            <div class="report">Report</div>
                        </div>
                    </div>
                </div>
                <div class="caption {% if not image[2].strip() %}no-caption{% endif %}">
                    {{ image[2] }}
                </div>
                <div class="image-container"><img src="{{ image[1] }}" class="image-post"></div>
                <div class="interactions">
                    <div class="lcs">
                        <form action="{{ url_for('like_image', image_id=image[0]) }}" method="post">
                            <button type="submit" style="all: unset;">
                                <div class="partner like-button">
                                    <span class="material-symbols-outlined lcs-symbol">thumb_up</span>
                                    <div class="partner-label">Like</div>
                                </div>
                            </button>
                        </form>
                        <div class="partner" id="openOverlayComments-{{ loop.index }}">
                            <span class="material-symbols-outlined lcs-symbol">comment</span>
                            <div class="partner-label">Comment</div>
                        </div>
                        <div class="partner" id="openOverlayShare-{{ loop.index }}">
                            <span class="material-symbols-outlined lcs-symbol">share</span>
                            <div class="partner-label">Share</div>
                        </div>
                    </div>
                    <div class="metrics" id="openOverlayLikes-{{ loop.index }}">
                        {{ image[3] }} {{ 'Like' if image[3] == 1 else 'Likes' }}
                    </div>
                </div>
            </div>
            <div class="overlayLikes" id="overlayLikes-{{ loop.index }}">
                <div class="overlay-content-likes">
                    <button class="close-icon"><span class="material-symbols-outlined overlay-close-symbol"
                            id="closeOverlayLikes-{{ loop.index }}">close</span></button>
                    <div class="overlay-title">Likes</div>
                    <div class="scrollable-div-likes" id="scrollableDivLikes-{{ loop.index }}">
                        {% if likes_data[image[0]] %}
                        {% for like in likes_data[image[0]] %}
                        <div class="profile-follow-wrapper">
                            <div class="profile-post-likes">
                                <img src="..\static\pfp.jpg" class="pfp">
                                <div class="profile-name-date">
                                    <div class="username">{{ like[0] }}</div>
                                    <div class="date">{{ like[1] }}</div>
                                </div>
                            </div>
                            <button class="follow-button">Befriend</button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="likes-empty">
                            <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                            <div class="oops">Oops!</div>
                            <div class="nothing">Nothing to show here at the moment.</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="overlayComments" id="overlayComments-{{ loop.index }}">
                <div class="overlay-content-comments">
                    <button class="close-icon"><span class="material-symbols-outlined overlay-close-symbol"
                            id="closeOverlayComments-{{ loop.index }}">close</span></button>
                    <div class="overlay-title">Comment</div>
                    <div class="scrollable-div-comments" id="scrollableDivComments-{{ loop.index }}">
                        {% set ns = namespace(has_comments=false) %}

                        {% for comment in comments %}
                        {% if comment[1] == image[0] %}
                        {% set ns.has_comments = true %}
                        <div class="profile-comment-wrapper">
                            <div class="profile-more-wrapper">
                                <div class="profile-post-comments">
                                    <img src="..\static\pfp.jpg" class="pfp">
                                    <div class="profile-name-date">
                                        <div class="username"><a href="{{ url_for('profile', user_id=comment[6]) }}">{{
                                                comment[2] }}</a></div>
                                        <div class="date">Jan 1</div>
                                    </div>
                                </div>
                                <div class="more-frame-wrapper">
                                    <!--<span class="material-symbols-outlined more-symbol">more_horiz</span>-->
                                </div>
                            </div>
                            <div class="comment-like-wrapper">
                                <div class="comment">{{ comment[3] }}</div>
                                <div class="like-metrics-wrapper">
                                    <form action="{{ url_for('like_comment', comment_id=comment[0]) }}" method="post">
                                        <button type="submit" style="all: unset;">
                                            <div class="partner comment-like-button"> <span
                                                    class="material-symbols-outlined lcs-symbol">thumb_up</span>
                                                <div class="partner-label">Like</div>
                                            </div>
                                        </button>
                                    </form>
                                    <div class="metrics" id="openOverlayCommentLikes-{{ loop.index }}">
                                        {{ comment[5] }} {{ 'Like' if comment[5] == 1 else 'Likes' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="overlayLikes" id="overlayCommentLikes-{{ loop.index }}">
                            <div class="overlay-content-likes">
                                <button class="close-icon"><span class="material-symbols-outlined overlay-close-symbol"
                                        id="closeOverlayCommentLikes-{{ loop.index }}">close</span></button>
                                <div class="overlay-title">Likes</div>
                                <div class="scrollable-div-likes" id="scrollableDivCommentLikes-{{ loop.index }}">
                                    {% if comment_likes_data[comment[0]] %}
                                    {% for comment_like in comment_likes_data[comment[0]] %}
                                    <div class="profile-follow-wrapper">
                                        <div class="profile-post-likes">
                                            <img src="..\static\pfp.jpg" class="pfp">
                                            <div class="profile-name-date">
                                                <div class="username">{{ comment_like[0] }}</div>
                                                <div class="date">{{ comment_like[1] }}</div>
                                            </div>
                                        </div>
                                        <button class="follow-button">Befriend</button>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="likes-empty">
                                        <span
                                            class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                                        <div class="oops">Oops!</div>
                                        <div class="nothing">Nothing to show here at the moment.</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="line-comments"></div>
                        {% endif %}
                        {% endfor %}
                        {% if not ns.has_comments %}
                        <div class="comments-empty">
                            <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                            <div class="oops">Oops!</div>
                            <div class="nothing">Nothing to show here at the moment.</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="comment-bar">
                        <img src="..\static\pfp.jpg" class="pfp">
                        <form class="comment-text" action="{{ url_for('post_comment', image_id=image[0]) }}"
                            method="POST">
                            <input class="tagline-comment" type="text" name="comment" placeholder="Enter your comment"
                                required>
                            <button class="send-button" type="submit">Send</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="overlayShare" id="overlayShare-{{ loop.index }}">
                <div class="overlay-content-share">
                    <button class="close-icon"><span class="material-symbols-outlined overlay-close-symbol"
                            id="closeOverlayShare-{{ loop.index }}">close</span></button>
                    <div class="overlay-title">Share</div>
                    <div class="share-wrapper">
                        <div class="share-via">Share via</div>
                        <div class="icon-grid">
                            <img src="..\static\fb.png" class="fb">
                            <img src="..\static\ig.png" class="ig">
                            <img src="..\static\x.png" class="x">
                            <img src="..\static\gmail.png" class="gmail">
                            <img src="..\static\linkedin.png" class="linkedin">
                            <img src="..\static\telegram.png" class="telegram">
                        </div>
                        <div class="or-copy-link">or copy link</div>
                        <div class="link-wrapper">
                            <div class="link">https://ocularis.app/post/123</div>
                            <button class="link-button"><span
                                    class="material-symbols-outlined link-symbol">content_copy</span></button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="right-sidebar-container">
            <div class="right-sidebar">
                <div class="pfp-frame-wrapper">
                    <div><img src="..\static\pfp.jpg" class="pfp right" id="pfp"></div>
                    <div class="frame2" id="frame2">
                        <div class="frame-username">{{ current_user.first_name }} {{ current_user.last_name }}</div>
                        <div class="line"></div>
                        <div class="saved">Saved</div>
                        <div class="settings">Settings</div>
                    </div>
                </div>
                <div class="notifs">
                    <div class="notifs-title">
                        Notifs
                    </div>
                    {% if notifications %}
                    {% for username, action, image_id, created_at in notifications %}
                    <div class="notif-bar">
                        <img src="..\static\pfp.jpg" class="pfp img-notif-request">
                        <div class="notif-details">
                            <div class="notif-text">
                                {{ username }}
                                {% if action == 'like' %}
                                liked your <a href="{{ url_for('feed') }}#image-{{ image_id }}">post</a>.
                                {% elif action == 'comment' %}
                                commented on your <a href="{{ url_for('feed') }}#image-{{ image_id }}">post</a>.
                                {% endif %}
                            </div>
                            <div class="notif-date">
                                {{ created_at.strftime('%b %#d') }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="notifs-empty">
                        <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                        <div class="oops">Oops!</div>
                        <div class="nothing">Nothing to show here at the moment.</div>
                    </div>
                    {% endif %}
                </div>
                <div class="requests">
                    <div class="requests-title">
                        Requests
                    </div>
                    {% if requests %}
                    {% for request_id, first_name, last_name, created_at in requests %}
                    <div class="request-bar">
                        <img src="..\static\pfp.jpg" class="pfp img-notif-request">
                        <div class="request-details">
                            <div class="request-text">
                                {{ first_name }} {{ last_name }} sent you a friend request.
                            </div>
                            <div class="request-date">
                                {{ created_at.strftime('%b %#d') }}
                            </div>
                            <div class="request-icons">
                                <button class="circled-icon-1"><span class="material-symbols-outlined close-symbol"
                                        onclick="window.location.href='/reject_request/{{ request_id }}'">close</span></button>
                                <button class="circled-icon-2"><span class="material-symbols-outlined check-symbol"
                                        onclick="window.location.href='/accept_request/{{ request_id }}'">check</span></button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="notifs-empty">
                        <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                        <div class="oops">Oops!</div>
                        <div class="nothing">Nothing to show here at the moment.</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if show_profile_modal %}
        <div id="profileModal" class="modal show">
            <form method="POST" id="profileForm" action="/api/setup-profile">
                <h2>Your Skills</h2>
                {% for category in categories %}
                <label>
                    <input type="checkbox" name="skills" value="{{ category }}">
                    {{ category }}
                </label><br>
                {% endfor %}

                <h2>Your Preferences</h2>
                {% for category in categories %}
                <label>
                    <input type="checkbox" name="preferences" value="{{ category }}">
                    {{ category }}
                </label><br>
                {% endfor %}

                <h2>Experience Level</h2>
                <label for="experience_level">Select your level:</label><br>
                <select name="experience_level" id="experience_level" required>
                    {% for value, label in experience_levels %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select><br><br>

                <h2>Your Role</h2>
                <label for="role">What best describes your role?</label><br>
                <input type="text" id="role" name="role" maxlength="100" required><br><br>

                <h2>Location</h2>
                <label for="country">Country:</label><br>
                <select id="country" name="country" required>
                    <option value="">Select Country</option>
                    {% for country in countries %}
                    <option value="{{ country.name }}" data-iso="{{ country.iso2 }}">{{ country.name }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="state">State/Region:</label><br>
                <select id="state" name="state" required>
                    <option value="">Select State</option>
                </select><br><br>

                <label for="city">City:</label><br>
                <select id="city" name="city" required>
                    <option value="">Select City</option>
                </select><br><br>

                <h2>Social Media Links</h2>
                <label for="facebook">Facebook:</label><br>
                <input type="url" id="facebook" name="facebook" placeholder="https://facebook.com/yourprofile"><br><br>

                <label for="instagram">Instagram:</label><br>
                <input type="url" id="instagram" name="instagram"
                    placeholder="https://instagram.com/yourprofile"><br><br>

                <label for="x">X (Twitter):</label><br>
                <input type="url" id="x" name="x" placeholder="https://x.com/yourprofile"><br><br>

                <label for="linkedin">LinkedIn:</label><br>
                <input type="url" id="linkedin" name="linkedin"
                    placeholder="https://linkedin.com/in/yourprofile"><br><br>

                <label for="telegram">Telegram:</label><br>
                <input type="url" id="telegram" name="telegram" placeholder="https://t.me/yourusername"><br><br>

                <button type="submit">Save Profile</button>
            </form>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const countrySelect = document.getElementById('country');
            const stateSelect = document.getElementById('state');
            const citySelect = document.getElementById('city');

            let allStates = [];
            let allCities = [];

            // Fetch all states and cities once
            fetch('/api/get-states')
                .then(res => res.json())
                .then(data => {
                    allStates = data;
                    console.log('Fetched States:', allStates);
                });

            fetch('/api/get-cities')
                .then(res => res.json())
                .then(data => {
                    allCities = data;
                    console.log('Fetched Cities:', allCities);
                });

            // When a country is selected
            countrySelect.addEventListener('change', () => {
                const selectedIso = countrySelect.options[countrySelect.selectedIndex].dataset.iso;  // Get selected country ISO
                stateSelect.innerHTML = '<option value="">Select State</option>';  // Reset state options
                citySelect.innerHTML = '<option value="">Select City</option>';  // Reset city options

                if (!selectedIso) return;  // If no country is selected, do nothing

                const filteredStates = allStates.filter(state => state.country_code === selectedIso);  // Filter states by country_code
                console.log('Filtered States:', filteredStates);  // Log filtered states to check if it's correct

                // Add filtered states to the state dropdown
                filteredStates.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state.state_code;  // Using state_code as value for easy reference
                    option.textContent = state.name;
                    stateSelect.appendChild(option);
                });
            });

            stateSelect.addEventListener('change', () => {
                const selectedStateCode = stateSelect.value;
                const selectedCountryIso = countrySelect.options[countrySelect.selectedIndex].dataset.iso;

                citySelect.innerHTML = '<option value="">Select City</option>';  // Reset city options

                console.log('Selected country ISO:', selectedCountryIso);
                console.log('Selected state code:', selectedStateCode);

                if (!selectedStateCode || !selectedCountryIso) return;

                // Fetch cities from backend using query parameters
                fetch(`/api/get-cities?country=${selectedCountryIso}&state=${selectedStateCode}`)
                    .then(res => res.json())
                    .then(filteredCities => {
                        filteredCities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.name;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching cities:', error);
                    });
            });

            let scrollPosition = 0;

            function setupOverlay(overlaySelector, openBtnId, closeBtnId, isNested = false) {
                const overlay = document.querySelector(overlaySelector);
                const openBtn = document.getElementById(openBtnId);
                const closeBtn = document.getElementById(closeBtnId);

                if (!overlay || !openBtn || !closeBtn) return;

                openBtn.addEventListener('click', () => {
                    if (!isNested) {
                        scrollPosition = window.scrollY;
                        document.body.style.top = `-${scrollPosition}px`;
                        document.body.classList.add('no-scrolling');
                    }
                    overlay.classList.add('active');
                });

                function closeOverlay() {
                    overlay.classList.remove('active');
                    if (!isNested) {
                        document.body.classList.remove('no-scrolling');
                        document.body.style.top = '';
                        window.scrollTo(0, scrollPosition);
                    }
                }

                closeBtn.addEventListener('click', closeOverlay);

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeOverlay();
                    }
                });
            }

            setupOverlay('.overlay', 'openOverlay', 'closeOverlay');

            document.querySelectorAll('[id^="overlayLikes-"]').forEach((overlay) => {
                const index = overlay.id.split('-')[1];
                setupOverlay(`#overlayLikes-${index}`, `openOverlayLikes-${index}`, `closeOverlayLikes-${index}`);
            });

            document.querySelectorAll('[id^="overlayCommentLikes-"]').forEach((overlay) => {
                const index = overlay.id.split('-')[1];
                setupOverlay(`#overlayCommentLikes-${index}`, `openOverlayCommentLikes-${index}`, `closeOverlayCommentLikes-${index}`, true);
            });

            document.querySelectorAll('[id^="overlayComments-"]').forEach((overlay) => {
                const index = overlay.id.split('-')[1];
                setupOverlay(`#overlayComments-${index}`, `openOverlayComments-${index}`, `closeOverlayComments-${index}`);
            });

            document.querySelectorAll('[id^="overlayShare-"]').forEach((overlay) => {
                const index = overlay.id.split('-')[1];
                setupOverlay(`#overlayShare-${index}`, `openOverlayShare-${index}`, `closeOverlayShare-${index}`);
            });

            const moreBtns = document.querySelectorAll('.more-symbol');
            const allFrames1 = document.querySelectorAll('.frame1');

            const pfp = document.getElementById('pfp');
            const frame2 = document.getElementById('frame2');
            const pfp3 = document.getElementById('pfp3');
            const frame3 = document.getElementById('frame3');
            const pfp4 = document.getElementById('pfp4');
            const frame4 = document.getElementById('frame4');

            allFrames1.forEach(frame => frame.style.display = 'none');
            if (frame2) frame2.style.display = 'none';
            if (frame3) frame3.style.display = 'none';
            if (frame4) frame4.style.display = 'none';

            let isFrame234Open = false;

            moreBtns.forEach((btn, index) => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const currentFrame = document.getElementById(`frame1-${index + 1}`);
                    const isOpen = currentFrame.style.display === 'block';

                    allFrames1.forEach(frame => frame.style.display = 'none');

                    currentFrame.style.display = isOpen ? 'none' : 'block';

                    if (frame2) frame2.style.display = 'none';
                    if (frame3) frame3.style.display = 'none';
                    if (frame4) frame4.style.display = 'none';
                    isFrame234Open = false;
                });
            });

            if (pfp) {
                pfp.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isOpen = frame2.style.display === 'block';
                    if (isOpen) {
                        frame2.style.display = 'none';
                        frame3.style.display = 'none';
                        frame4.style.display = 'none';
                        isFrame234Open = false;
                    } else {
                        frame2.style.display = 'block';
                        frame3.style.display = 'block';
                        frame4.style.display = 'block';
                        allFrames1.forEach(frame => frame.style.display = 'none');
                        isFrame234Open = true;
                    }
                });
            }

            if (pfp3) {
                pfp3.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isOpen = frame3.style.display === 'block';
                    if (isOpen) {
                        frame2.style.display = 'none';
                        frame3.style.display = 'none';
                        frame4.style.display = 'none';
                        isFrame234Open = false;
                    } else {
                        frame2.style.display = 'block';
                        frame3.style.display = 'block';
                        frame4.style.display = 'block';
                        allFrames1.forEach(frame => frame.style.display = 'none');
                        isFrame234Open = true;
                    }
                });
            }

            if (pfp4) {
                pfp4.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isOpen = frame4.style.display === 'block';
                    if (isOpen) {
                        frame2.style.display = 'none';
                        frame3.style.display = 'none';
                        frame4.style.display = 'none';
                        isFrame234Open = false;
                    } else {
                        frame2.style.display = 'block';
                        frame3.style.display = 'block';
                        frame4.style.display = 'block';
                        allFrames1.forEach(frame => frame.style.display = 'none');
                        isFrame234Open = true;
                    }
                });
            }

            document.addEventListener('click', function (event) {
                moreBtns.forEach((btn, index) => {
                    const frame = document.getElementById(`frame1-${index + 1}`);
                    if (!frame.contains(event.target) && event.target !== btn) {
                        frame.style.display = 'none';
                    }
                });

                if (frame2 && !frame2.contains(event.target) && event.target !== pfp) {
                    frame2.style.display = 'none';
                }
                if (frame3 && !frame3.contains(event.target) && event.target !== pfp3) {
                    frame3.style.display = 'none';
                }
                if (frame4 && !frame4.contains(event.target) && event.target !== pfp4) {
                    frame4.style.display = 'none';
                }

                const frame2Visible = frame2 && window.getComputedStyle(frame2).display !== 'none';
                const frame3Visible = frame3 && window.getComputedStyle(frame3).display !== 'none';
                const frame4Visible = frame4 && window.getComputedStyle(frame4).display !== 'none';

                if (!frame2Visible && !frame3Visible && !frame4Visible) {
                    isFrame234Open = false;
                }
            });

            window.addEventListener('resize', function () {
                if (isFrame234Open) {
                    frame2.style.display = 'block';
                    frame3.style.display = 'block';
                    frame4.style.display = 'block';
                }
            });

            function checkScrollbar() {
                const imageInput = document.getElementById('image');
                const div = document.getElementById('scrollableDiv');
                const likeDivs = document.querySelectorAll('[id^="scrollableDivLikes"]');
                const commentLikeDivs = document.querySelectorAll('[id^="scrollableDivCommentLikes"]');
                const commentDivs = document.querySelectorAll('[id^="scrollableDivComments"]');

                if (imageInput && div) {
                    div.classList.remove('no-scroll', 'has-scroll');
                    if (imageInput.files.length > 0) {
                        div.classList.add('has-scroll');
                    } else {
                        div.classList.add('no-scroll');
                    }
                }

                const checkScrollState = (divList) => {
                    divList.forEach(el => {
                        el.classList.remove('no-scroll', 'has-scroll');
                        if (el.scrollHeight > el.clientHeight) {
                            el.classList.add('has-scroll');
                        } else {
                            el.classList.add('no-scroll');
                        }
                    });
                };

                checkScrollState(likeDivs);
                checkScrollState(commentDivs);
                checkScrollState(commentLikeDivs);
            }

            const imageInput = document.getElementById('image');
            if (imageInput) {
                imageInput.addEventListener('change', checkScrollbar);
            }
            checkScrollbar();

            const likeButtons = document.querySelectorAll(".like-button");
            likeButtons.forEach(button => {
                button.addEventListener("click", () => {
                    button.classList.toggle("liked");
                });
            });

            function setFullHeight() {
                const rightSidebar = document.querySelector('.right-sidebar');
                const leftSidebar = document.querySelector('.left-sidebar');
                if (rightSidebar) rightSidebar.style.height = window.innerHeight + 'px';
                if (leftSidebar) leftSidebar.style.height = window.innerHeight + 'px';
            }

            window.addEventListener('resize', setFullHeight);
            setFullHeight();

            const imageInputPreview = document.getElementById('image');
            const imageWrapper = document.getElementById('imageWrapper');
            const imagePreview = document.getElementById('uploadedImagePreview');
            const closeButton = document.getElementById('closeButton');

            if (imageInputPreview) {
                imageInputPreview.addEventListener('change', function () {
                    const file = this.files[0];

                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            imagePreview.src = e.target.result;
                            imageWrapper.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.src = '';
                        imageWrapper.style.display = 'none';
                    }
                });
            }

            if (closeButton) {
                closeButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    imagePreview.src = '';
                    imageWrapper.style.display = 'none';
                    imageInputPreview.value = '';
                });
            }

            const circledClose = document.querySelector('.circled-icon-1-overlay-version');
            if (circledClose) {
                circledClose.addEventListener('click', function () {
                    document.getElementById('uploadedImagePreview').src = '';
                    document.getElementById('image').value = '';
                    document.getElementById('imageWrapper').style.display = 'none';
                });
            }

            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const response = await fetch('/api/setup-profile', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('profileModal').style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>

</html>